# Feature #2.1: Store-Based UI State Tracking

## Overview
Implement global UI state tracking without changing URL paths to maintain consistent awareness of user navigation and context throughout the application. This approach simplifies implementation while still ensuring Kalypso AI has proper context about what the user is doing at all times.

## Goals and Expected Outcomes
1. Complete structured navigation tracking throughout the app
2. Contextual information available for Kalypso based on user's location
3. Simplified and consistent navigation API
4. Maintain existing tab-based navigation while tracking state globally

## Implementation Strategy
We'll enhance the existing UISlice with a structured navigation object that tracks both the current page and subsections, along with contextual information specific to each tab/section. This maintains the current tab-based navigation within components but ensures global state awareness through the store.

## Key Benefits of This Approach
1. **Speed of implementation**: Much faster than full URL-based navigation
2. **Reduced complexity**: Avoids challenges with state persistence across route changes
3. **Maintains current UX**: Users will experience the same behavior they're familiar with
4. **Provides global context**: Kalypso AI still gets full context through the store
5. **Progressive path**: Can be enhanced with URL-based navigation in the future

## Implementation Details

### 1. State Consolidation
- **Current State**: Tab state is currently managed in component-level state (e.g., `pageState.activeTab` in HomePage)
- **New Approach**: Mirror this state in the global UISlice, keeping local state for backward compatibility
- **Implementation**: When tabs change, update both local state and the navigation object in UISlice

### 2. Context Preservation
- **Current State**: `pageState` tracks things like `chatbotContext` and `activities` across tabs
- **New Approach**: Continue using this approach but ensure key context is also available in the store
- **Implementation**: Sync critical context data to the UISlice's subSection property

### 3. Activity Tracking
- **Current State**: Activity tracking happens at tab change through `handleActivityChange`
- **New Approach**: Maintain this approach but ensure the store has current activity information
- **Implementation**: Update UISlice's navigation state with activity tracking data

### 4. Component Communication
- **Current State**: Components receive props from parent (e.g., `handleSetTab`, `chatbotRef`)
- **New Approach**: Enable these components to read state from and dispatch actions to the store
- **Implementation**: Create selectors for store access in child components

## Implementation Checklist

### Core Navigation Structure
- ✅ Enhanced UISlice with structured navigation
- ✅ Added `page` property to track main section
- ✅ Added `subSection` object for context data
- ✅ Implemented action creators:
  - ✅ `setNavigation` updates both page and subsection data
  - ✅ `updateSubSection` updates only subsection data
  - ✅ `clearNavigation` resets navigation when needed
- ✅ Created navigation hook for consistent access
- ✅ Synced HoverSidebar to navigation store state

### State Management Enhancement
- [ ] Audit all component-local state that should be mirrored to store
- [ ] Update tab change handlers to sync state to store
- [ ] Create selectors for commonly accessed navigation data
- [ ] Identify critical context that should be in global state
- [ ] Add debug logging for state transitions

### Activity Tracking Integration
- ✅ Added activity information to navigation state
- [ ] Update all activity start/end handlers to update store
- [ ] Create activity tracking utilities that integrate with store
- [ ] Add activity ID to navigation context

### Component Communication
- [ ] Create selectors for child components to access store
- [ ] Implement store-based callbacks for component events
- [ ] Update PracticeTests to use store for state and callbacks
- [ ] Update ATS components to use store for state and callbacks

### Kalypso Integration
- ✅ Updated Kalypso context provider to access navigation state
- ✅ Passed relevant navigation data to Kalypso
- ✅ Enabled Kalypso to respond with context awareness

### Debug Tools
- [ ] Create debug panel to display current navigation state
- [ ] Add navigation state logging
- [ ] Display activity tracking information in debug mode

## Component Update Example

```typescript
// Example: Updating component to use store-based navigation

// Before: Component using local state only
const PracticeTests = ({ onTabChange, chatbotRef }) => {
  const [activeTest, setActiveTest] = useState(null);
  
  const handleTestSelect = (test) => {
    setActiveTest(test);
    // Communicate back to parent
    onTabChange(`Tests?view=${test.id}`);
  };
  
  // ...
};

// After: Component using both local state and store
const PracticeTests = () => {
  const [activeTest, setActiveTest] = useState(null);
  const { updateSubSection } = useUI();
  const { setNavigation } = useNavigation();
  
  const handleTestSelect = (test) => {
    setActiveTest(test);
    
    // Update global navigation state
    updateSubSection({
      activeTest: test.id,
      testName: test.name,
      view: `Tests?view=${test.id}`
    });
    
    // For compatibility with existing code
    onTabChange(`Tests?view=${test.id}`);
  };
  
  // ...
};
```

## Testing Plan

1. **Core Navigation Testing**
   - [ ] Verify navigation state updates correctly when tabs change
   - [ ] Check subsection data updates with context
   - [ ] Verify state persists correctly during tab changes

2. **Activity Tracking Testing**
   - [ ] Confirm activities start/end properly with tab changes
   - [ ] Verify activity IDs are tracked in navigation state
   - [ ] Test with various user flows to ensure tracking is consistent

3. **Kalypso Integration Testing**
   - ✅ Verify Kalypso receives proper navigation context
   - [ ] Test context-aware responses based on different tabs

4. **Performance Testing**
   - [ ] Measure render performance with state in store vs. local
   - [ ] Check for unnecessary re-renders with context updates
   - [ ] Verify large state objects don't impact performance